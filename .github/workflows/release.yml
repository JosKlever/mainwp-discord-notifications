name: Tag and Release

on:
  push:
    paths:
      - 'mainwp-discord-notifications.php'

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Extract version
        id: extract_version
        run: |
          version=$(grep -i 'Version:' mainwp-discord-notifications.php | awk '{print $2}')
          echo "Version extracted: $version"
          echo "::set-output name=version::$version"

      - name: Create tag
        id: create_tag
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.RELEASES_TOKEN }}
          script: |
            const version = process.env.VERSION;
            const tagName = `v${version}`;
            const { data: tags } = await github.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const tagExists = tags.find(tag => tag.name === tagName);
            if (tagExists) {
              console.log(`Tag ${tagName} already exists`);
              return { tag_exists: "true" };
            } else {
              await github.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`Tag ${tagName} created`);
              return { tag_exists: "false" };
            }

      - name: Create Release
        if: steps.create_tag.outputs.tag_exists == 'false'
        uses: actions/create-release@v1
        env:
          RELEASES_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          release_name: Release ${{ steps.extract_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## [${{ steps.extract_version.outputs.version }}] - $(date +'%Y-%m-%d')
            - Updated plugin version to ${{ steps.extract_version.outputs.version }}
            - Include the changes from the appropriate section of the changelog here.
